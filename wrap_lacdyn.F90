
USE PARKIND1,  ONLY : JPIM, JPRB
USE YOMGMV,    ONLY : TGMV
USE YOMOROG,   ONLY : TOROG
USE YOMGSGEOM, ONLY : TGSGEOM
USE YOMDIMV  , ONLY : YRDIMV
USE LOAD_MOD

IMPLICIT NONE

INTERFACE SETALL
  PROCEDURE SETALLI1
  PROCEDURE SETALLI2
  PROCEDURE SETALLX1
  PROCEDURE SETALLX2
  PROCEDURE SETALLX3
  PROCEDURE SETALL_GMV
  PROCEDURE SETALL_TGSGEOM
  PROCEDURE SETALL_TOROG
END INTERFACE

INTERFACE DDIFF
  PROCEDURE DDIFFX1
  PROCEDURE DDIFFX2
  PROCEDURE DDIFFX3
END INTERFACE

INTEGER(KIND=JPIM), ALLOCATABLE  :: IFDIA (:)

TYPE(TGMV)        , POINTER      :: YDGMV_ALL(:)
INTEGER(KIND=JPIM)               :: KIDIA 
INTEGER(KIND=JPIM)               :: KFDIA 
INTEGER(KIND=JPIM), POINTER      :: KSETTLOFF_ALL(:,:)
REAL(KIND=JPRB)                  :: PBETADT 
REAL(KIND=JPRB)                  :: PDT 
REAL(KIND=JPRB)   , POINTER      :: PSLHDA_ALL(:,:)
REAL(KIND=JPRB)   , POINTER      :: PSLHDD0_ALL(:,:)
TYPE(TGSGEOM)     , POINTER      :: YDGSGEOM_ALL(:)
TYPE(TOROG)       , POINTER      :: YDOROG_ALL(:)
REAL(KIND=JPRB)   , POINTER      :: POROGL_ALL(:,:)
REAL(KIND=JPRB)   , POINTER      :: POROGM_ALL(:,:) 
REAL(KIND=JPRB)   , POINTER      :: PVCRSSA9F_ALL(:,:,:) 
REAL(KIND=JPRB)   , POINTER      :: PNHXT9_ALL(:,:,:) 
REAL(KIND=JPRB)   , POINTER      :: PVCRS0_ALL(:,:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PVCW0F_ALL(:,:,:) 
REAL(KIND=JPRB)   , POINTER      :: PWDLW0F_ALL(:,:,:) 
REAL(KIND=JPRB)   , POINTER      :: PRDLR0_ALL(:,:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PRDLR9_ALL(:,:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PNHXT0_ALL(:,:,:) 
REAL(KIND=JPRB)   , POINTER      :: PRES0_ALL(:,:,:) 
REAL(KIND=JPRB)   , POINTER      :: PRDELP0_ALL(:,:,:) 
REAL(KIND=JPRB)   , POINTER      :: PCTY0_ALL(:,:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PUVH0_ALL(:,:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PATND_ALL(:,:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PDBBC_ALL(:,:)
REAL(KIND=JPRB)   , POINTER      :: PRDPHI_ALL(:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PGWT0_ALL(:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PGWT9_ALL(:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PGFL_ALL(:,:,:,:) 
REAL(KIND=JPRB)   , POINTER      :: PGMV_ALL(:,:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PGMVS_ALL(:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PB1_ALL(:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PB2_ALL(:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PGMVT1_ALL(:,:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PGMVT1S_ALL(:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PGWS_ALL(:,:)
REAL(KIND=JPRB)   , POINTER      :: PGMVTNDSI_ALL(:,:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PWRL95_ALL(:,:,:)
REAL(KIND=JPRB)   , POINTER      :: PSTACK_ALL(:,:,:)


INTEGER :: IBL, ICOUNT, KLON, JJ, JIDIA, JFDIA
INTEGER :: KPSTSZ, KPSTPT

#include "lacdyn.intfb.h"

OPEN (77, FORM='FORMATTED', FILE='LACDYN.COUNT')
READ (77, *) ICOUNT
CLOSE (77)


ALLOCATE (IFDIA (ICOUNT))

CALL LACDYN_LOAD_ALL

CALL OPEN_LOAD ("LACDYN")


DO IBL = 1, ICOUNT

#define SET(x) CALL SETALL (x##_ALL)

  SET (YDGMV)
  CALL LOAD (ILUN_IN, KIDIA)
  CALL LOAD (ILUN_IN, IFDIA (IBL))
  IF (IBL == 1) KLON = IFDIA (IBL)
  CALL LOAD (ILUN_IN, PBETADT)
  CALL LOAD (ILUN_IN, PDT)
  SET (YDGSGEOM)
  SET (YDOROG)
  SET (PSLHDA)
  SET (PSLHDD0)
  CALL SETALL (KSETTLOFF_ALL, .FALSE.)
  SET (POROGL)
  SET (POROGM)
  CALL SETALL (PVCRSSA9F_ALL, .FALSE.)
  SET (PNHXT9)
  CALL SETALL (PVCRS0_ALL, .FALSE.)
  CALL SETALL (PVCW0F_ALL, .FALSE.)
  CALL SETALL (PWDLW0F_ALL, .FALSE.)
  CALL SETALL (PRDLR0_ALL, .FALSE.)
  CALL SETALL (PRDLR9_ALL, .FALSE.)
  SET (PNHXT0)
  SET (PRES0)
  SET (PRDELP0)
  SET (PCTY0)
  SET (PUVH0)
  SET (PATND)
  CALL SETALL (PDBBC_ALL, .FALSE.)
  CALL SETALL (PRDPHI_ALL, .FALSE.)
  CALL SETALL (PGWT0_ALL, .FALSE.)
  CALL SETALL (PGWT9_ALL, .FALSE.)
  SET (PGFL)
  SET (PGMV)
  SET (PGMVS)
  SET (PB1)
  SET (PB2)
  SET (PGMVT1)
  SET (PGMVT1S)
  CALL SETALL (PGWS_ALL, .FALSE.)
! SET (PGMVTNDSI)
  SET (PWRL95)

#undef SET

ENDDO


KIDIA = 1
KFDIA = KLON

ALLOCATE (PGMVTNDSI_ALL (1, 1, 1, 1))

KPSTSZ = 15 * YRDIMV%NFLEVG
KPSTPT = 1

ALLOCATE (PSTACK_ALL (KLON, KPSTSZ, ICOUNT))


!$OMP PARALLEL DO PRIVATE (IBL,JIDIA,JFDIA)
DO IBL = 1, ICOUNT

PRINT *, IBL

  DO JJ = KIDIA, KFDIA

    JIDIA = JJ
    JFDIA = JJ

    CALL LACDYN(PSTACK_ALL(:,:,IBL),KPSTSZ,KPSTPT,KLON,YDGMV_ALL(IBL),JIDIA,JFDIA,PBETADT,PDT,&
     & PSLHDA_ALL(:,IBL),PSLHDD0_ALL(:,IBL),YDGSGEOM_ALL(IBL),YDOROG_ALL(IBL),POROGL_ALL(:,IBL),&
     & POROGM_ALL(:,IBL),PVCRSSA9F_ALL(:,:,IBL),PNHXT9_ALL(:,:,IBL),&
     & PVCRS0_ALL(:,:,:,IBL),PVCW0F_ALL(:,:,IBL),PWDLW0F_ALL(:,:,IBL),&
     & PRDLR0_ALL(:,:,:,IBL),PRDLR9_ALL(:,:,:,IBL),PNHXT0_ALL(:,:,IBL),&
     & PRES0_ALL(:,:,IBL),PRDELP0_ALL(:,:,IBL),PCTY0_ALL(:,:,:,IBL),PUVH0_ALL(:,:,:,IBL),&
     & PATND_ALL(:,:,:,IBL),PDBBC_ALL(:,IBL),PRDPHI_ALL(:,:,IBL),PGWT0_ALL(:,:,IBL),&
     & PGWT9_ALL(:,:,IBL),PGFL_ALL(:,:,:,IBL),&
     & KSETTLOFF_ALL(:,IBL),PGMV_ALL(:,:,:,IBL),PGMVS_ALL(:,:,IBL),PB1_ALL(:,:,IBL),&
     & PB2_ALL(:,:,IBL),PGMVT1_ALL(:,:,:,IBL),PGMVT1S_ALL(:,:,IBL),PGWS_ALL(:,IBL),&
     & PGMVTNDSI_ALL(:,:,:,IBL),PWRL95_ALL(:,:,IBL))

  ENDDO

ENDDO
!$OMP END PARALLEL DO


DO IBL = 1, ICOUNT

  PRINT *, IBL

#define DIFF(x) CALL DDIFF (#x, x##_ALL)

  DIFF (PGMV)
  DIFF (PGMVS)
  DIFF (PB1)
  DIFF (PB2)
  DIFF (PGMVT1)
  DIFF (PGMVT1S)
  DIFF (PGWS)
! DIFF (PGMVTNDSI)
  CALL DDIFF ("PWRL95", PWRL95_ALL, .FALSE.)

#undef DIFF

ENDDO


CALL CLOSE_LOAD

CONTAINS

SUBROUTINE SETALLI1 (KALL, LDPROMA)

INTEGER (KIND=JPIM), POINTER :: KALL (:,:), K (:)
LOGICAL, OPTIONAL :: LDPROMA
INTEGER :: KLB (1), KUB (1), JLON
LOGICAL :: LLPROMA

LLPROMA = .TRUE.
IF (PRESENT (LDPROMA)) LLPROMA = LDPROMA

CALL LOAD (ILUN_IN, K)

KLB = LBOUND (K)
KUB = UBOUND (K)

IF (IBL == 1) THEN
  ALLOCATE (KALL (KLB (1):KUB (1), ICOUNT))
ENDIF

KALL (:,IBL) = K (:)
DEALLOCATE (K)
NULLIFY (K)

IF (LLPROMA) THEN
DO JLON = IFDIA (IBL)+1, KLON
  KALL (JLON,IBL) = KALL (IFDIA (IBL),IBL)
ENDDO
ENDIF

END SUBROUTINE

SUBROUTINE SETALLI2 (KALL)

INTEGER (KIND=JPIM), POINTER :: KALL (:,:,:), K (:,:)
INTEGER :: KLB (2), KUB (2), JLON

CALL LOAD (ILUN_IN, K)

KLB = LBOUND (K)
KUB = UBOUND (K)

IF (IBL == 1) THEN
  ALLOCATE (KALL (KLB (1):KUB (1), KLB (2):KUB (2), ICOUNT))
ENDIF

KALL (:,:,IBL) = K (:,:)
DEALLOCATE (K)
NULLIFY (K)

DO JLON = IFDIA (IBL)+1, KLON
  KALL (JLON,:,IBL) = KALL (IFDIA (IBL),:,IBL)
ENDDO

END SUBROUTINE

SUBROUTINE SETALLX1 (PALL, LDPROMA)

REAL (KIND=JPRB), POINTER :: PALL (:,:), P (:)
LOGICAL, OPTIONAL :: LDPROMA
INTEGER :: KLB (1), KUB (1), JLON
LOGICAL :: LLPROMA

LLPROMA = .TRUE.
IF (PRESENT (LDPROMA)) LLPROMA = LDPROMA

CALL LOAD (ILUN_IN, P)

KLB = LBOUND (P)
KUB = UBOUND (P)

IF (IBL == 1) THEN
  ALLOCATE (PALL (KLB (1):KUB (1), ICOUNT))
ENDIF

PALL (:,IBL) = P (:)
DEALLOCATE (P)
NULLIFY (P)

IF (LLPROMA) THEN
DO JLON = IFDIA (IBL)+1, KLON
  PALL (JLON,IBL) = PALL (IFDIA (IBL),IBL)
ENDDO
ENDIF

END SUBROUTINE

SUBROUTINE SETALLX2 (PALL, LDPROMA)

REAL (KIND=JPRB), POINTER :: PALL (:,:,:), P (:,:)
LOGICAL, OPTIONAL :: LDPROMA
INTEGER :: KLB (2), KUB (2), JLON
LOGICAL :: LLPROMA

LLPROMA = .TRUE.
IF (PRESENT (LDPROMA)) LLPROMA = LDPROMA

CALL LOAD (ILUN_IN, P)

KLB = LBOUND (P)
KUB = UBOUND (P)

IF (IBL == 1) THEN
  ALLOCATE (PALL (KLB (1):KUB (1), KLB (2):KUB (2), ICOUNT))
ENDIF

PALL (:,:,IBL) = P (:,:)
DEALLOCATE (P)
NULLIFY (P)

IF (LLPROMA) THEN
DO JLON = IFDIA (IBL)+1, KLON
  PALL (JLON,:,IBL) = PALL (IFDIA (IBL),:,IBL)
ENDDO
ENDIF

END SUBROUTINE

SUBROUTINE SETALLX3 (PALL, LDPROMA)

REAL (KIND=JPRB), POINTER :: PALL (:,:,:,:), P (:,:,:)
LOGICAL, OPTIONAL :: LDPROMA
INTEGER :: KLB (3), KUB (3), JLON
LOGICAL :: LLPROMA

LLPROMA = .TRUE.
IF (PRESENT (LDPROMA)) LLPROMA = LDPROMA

CALL LOAD (ILUN_IN, P)

KLB = LBOUND (P)
KUB = UBOUND (P)

IF (IBL == 1) THEN
  ALLOCATE (PALL (KLB (1):KUB (1), KLB (2):KUB (2), KLB (3):KUB (3), ICOUNT))
ENDIF

PALL (:,:,:,IBL) = P (:,:,:)
DEALLOCATE (P)
NULLIFY (P)

IF (LLPROMA) THEN
DO JLON = IFDIA (IBL)+1, KLON
  PALL (JLON,:,:,IBL) = PALL (IFDIA (IBL),:,:,IBL)
ENDDO
ENDIF

END SUBROUTINE

SUBROUTINE SETALL_GMV (YDGMV_ALL)

TYPE (TGMV), POINTER :: YDGMV_ALL (:)

IF (IBL == 1) THEN
  ALLOCATE (YDGMV_ALL (ICOUNT))
ENDIF

CALL LOAD_TGMV (ILUN_IN, YDGMV_ALL (IBL))

END SUBROUTINE

SUBROUTINE SETALL_TGSGEOM (YDGSGEOM_ALL)

TYPE (TGSGEOM), POINTER :: YDGSGEOM_ALL (:)

IF (IBL == 1) THEN
  ALLOCATE (YDGSGEOM_ALL (ICOUNT))
ENDIF

CALL LOAD_TGSGEOM (ILUN_IN, YDGSGEOM_ALL (IBL))

END SUBROUTINE

SUBROUTINE SETALL_TOROG (YDOROG_ALL)

TYPE (TOROG), POINTER :: YDOROG_ALL (:)

IF (IBL == 1) THEN
  ALLOCATE (YDOROG_ALL (ICOUNT))
ENDIF

CALL LOAD_TOROG (ILUN_IN, YDOROG_ALL (IBL))

END SUBROUTINE

SUBROUTINE DDIFFX1 (CDNAME, PALL)

CHARACTER(LEN=*) :: CDNAME
REAL (KIND=JPRB) :: PALL (:,:)
REAL (KIND=JPRB), POINTER :: P (:)

CALL LOAD (ILUN_OUT, P)

IF (KFDIA == IFDIA (IBL)) &
CALL DIFF (CDNAME, PALL (:, IBL), P)

DEALLOCATE (P)

END SUBROUTINE

SUBROUTINE DDIFFX2 (CDNAME, PALL, LDDIFF)

CHARACTER(LEN=*) :: CDNAME
REAL (KIND=JPRB) :: PALL (:,:,:)
REAL (KIND=JPRB), POINTER :: P (:,:)
LOGICAL, OPTIONAL :: LDDIFF
LOGICAL :: LLDIFF

LLDIFF = .TRUE.
IF (PRESENT (LDDIFF)) LLDIFF = LDDIFF

CALL LOAD (ILUN_OUT, P)

IF (LLDIFF) THEN
IF (KFDIA == IFDIA (IBL)) &
CALL DIFF (CDNAME, PALL (:, :, IBL), P)
ENDIF

DEALLOCATE (P)

END SUBROUTINE

SUBROUTINE DDIFFX3 (CDNAME, PALL)

CHARACTER(LEN=*) :: CDNAME
REAL (KIND=JPRB) :: PALL (:,:,:,:)
REAL (KIND=JPRB), POINTER :: P (:,:,:)

CALL LOAD (ILUN_OUT, P)

IF (KFDIA == IFDIA (IBL)) &
CALL DIFF (CDNAME, PALL (:, :, :, IBL), P)

DEALLOCATE (P)

END SUBROUTINE




END 
